# IQDB API Python

![Python](https://img.shields.io/badge/python-3.8+-blue.svg)
![License](https://img.shields.io/badge/license-MIT-green.svg)
![Status](https://img.shields.io/badge/status-stable-brightgreen.svg)

Th∆∞ vi·ªán Python ƒë·ªÉ t√¨m ki·∫øm h√¨nh ·∫£nh ng∆∞·ª£c tr√™n [IQDB.org](https://iqdb.org) (Internet Query Database). ƒê√¢y l√† phi√™n b·∫£n Python ƒë∆∞·ª£c chuy·ªÉn ƒë·ªïi t·ª´ th∆∞ vi·ªán C# [IqdbApi](https://github.com/ImoutoChan/IqdbApi) g·ªëc.

## ‚ú® T√≠nh nƒÉng

### üîç Core Features
- **T√¨m ki·∫øm h√¨nh ·∫£nh ng∆∞·ª£c** tr√™n IQDB.org
- **T√¨m ki·∫øm b·∫±ng URL** ho·∫∑c **upload file**
- **H·ªó tr·ª£ c·∫£ 2D v√† 3D IQDB**
  - `www.iqdb.org`: Anime, manga, v√† h√¨nh ·∫£nh 2D
  - `3d.iqdb.org`: Cosplay v√† h√¨nh ·∫£nh 3D
- **API async v√† sync** - linh ho·∫°t cho m·ªçi use case

### üõ°Ô∏è Protection
- **Ban Prevention System** - H·ªá th·ªëng ch·ªëng ban n√¢ng cao
- **User-Agent Rotation** - Xoay v√≤ng UA strings
- **Random Delays** - Delay ng·∫´u nhi√™n gi·ªëng ng∆∞·ªùi d√πng th·ª±c
- **Session Management** - Unique session cho m·ªói client

### üé® Search Options
- **Ignore Colors** - T√¨m ki·∫øm b·ªè qua m√†u s·∫Øc (`ignore_colors=True`)
- **Search More Sources** - T√¨m ki·∫øm nhi·ªÅu database h∆°n (`search_more=True`)
- **Rate Limiting T√≠ch h·ª£p** - Tr√°nh b·ªã ban IP
- **Custom Configuration** - T√πy ch·ªânh timeout, delay, headers

### üìä Information APIs (build-in)
- **Supported Formats** - L·∫•y danh s√°ch format ƒë∆∞·ª£c h·ªó tr·ª£
- **Supported Sources** - Danh s√°ch database theo t·ª´ng IQDB
- **Client Info** - Th√¥ng tin c·∫•u h√¨nh hi·ªán t·∫°i
- **Session Tracking** - Monitor search sessions

### üîß Technical Features
- **Structured Data** - K·∫øt qu·∫£ parse th√†nh Python objects
- **Error Handling** chi ti·∫øt v·ªõi custom exceptions
- **Type Hints** ƒë·∫ßy ƒë·ªß cho development experience t·ªët h∆°n
- **Modern Packaging** - Python 3.8+ support

## üöÄ C√†i ƒë·∫∑t

### T·ª´ PyPI (comming soon)
```bash
pip install iqdb-api
```

### T·ª´ source
```bash
pip install --no-cache-dir "iqdb-api-python @ git+https://github.com/hieuxyz00/iqdb-api-python.git"
```

### Dependencies
```bash
pip install -r requirements.txt
```

## üìñ C√°ch s·ª≠ d·ª•ng c∆° b·∫£n

### Async API (Khuy√™n d√πng)

```python
import asyncio
from iqdb_api import IqdbClient

async def main():
    async with IqdbClient(prevent_bans=True) as client:
        image_url = "https://cdn.discordapp.com/attachments/123/456/image.jpg"
        # TODO: S·ª≠ d·ª•ng stream ƒë·ªÉ hi·ªÉn th·ªã tr·∫°ng th√°i queue real-time
        async for result in client.search_url_stream(image_url):
            if result.queue_status:
                msg = f"\r‚è≥ ƒêang trong h√†ng ƒë·ª£i IQDB... V·ªã tr√≠: {result.queue_status.queue_position} | ∆Ø·ªõc t√≠nh ch·ªù: {result.queue_status.estimated_wait}s "
                print(msg, end="", flush=True)
            else:
                print("\r", end="")
                print(f"\u2705 Th√†nh c√¥ng! T√¨m th·∫•y {len(result.matches)} k·∫øt qu·∫£")
                if result.best_matches:
                    print("\n‚≠êÔ∏è Best match:")
                    for match in result.best_matches:
                        print(f"- URL: {match.url}")
                break  # K·∫øt th√∫c khi ƒë√£ c√≥ k·∫øt qu·∫£ th·ª±c s·ª±

asyncio.run(main())
```

### Sync API (D·ªÖ s·ª≠ d·ª•ng)

```python
from iqdb_api import SyncIqdbClient

with SyncIqdbClient() as client:
    result = client.search_url("https://example.com/image.jpg")
    print(f"T√¨m th·∫•y {len(result.matches)} k·∫øt qu·∫£")
    # In ra best match (n·∫øu c√≥)
    if result.best_matches:
        print("\n‚≠êÔ∏è Best match:")
        for match in result.best_matches:
            print(f"- URL: {match.url}")
            print(f"  - Similarity: {match.similarity}% | Source: {match.source.value if match.source else None}")
    # In ra c√°c match kh√°c
    other_matches = [m for m in result.matches if not m.is_best_match]
    if other_matches:
        print("\nüîé Other matches:")
        for i, match in enumerate(other_matches, 1):
            print(f"[{i}] {match.url}")
```

### 3D IQDB (Cosplay & 3D Images)

```python
from iqdb_api import Iqdb3dClient

async with Iqdb3dClient() as client:
    result = await client.search_url("https://example.com/cosplay.jpg")
    print(f"3D IQDB: {len(result.matches)} k·∫øt qu·∫£")
```

## üéØ Advanced Features

### Ban Prevention & Rate Limiting
```python
from iqdb_api import IqdbClient

# C·∫•u h√¨nh ch·ªëng ban n√¢ng cao
async with IqdbClient(
    prevent_bans=True,           # B·∫≠t ch·ªëng ban
    rate_limit_seconds=6.0,      # TƒÉng delay gi·ªØa requests
    user_agent="Custom-Bot/1.0"  # Custom User-Agent
) as client:
    
    # Batch search an to√†n
    urls = ["url1.jpg", "url2.jpg", "url3.jpg"]
    for url in urls:
        result = await client.search_url(url)
        print(f"Found {len(result.matches)} matches")
        # T·ª± ƒë·ªông delay v·ªõi random jitter
```

### Search Options
```python
# T√¨m ki·∫øm n√¢ng cao
async with IqdbClient(
    ignore_colors=True,    # B·ªè qua m√†u s·∫Øc - t·ªët cho ·∫£nh ƒëen tr·∫Øng
    search_more=True,      # T√¨m tr√™n nhi·ªÅu database h∆°n
    prevent_bans=True      # Ch·ªëng ban v·ªõi User-Agent rotation
) as client:
    
    result = await client.search_url("https://example.com/image.jpg")
    
    # L·∫•y th√¥ng tin client
    info = client.get_search_info()
    print(f"Session: {info['session_id']}")
    print(f"Supported formats: {info['supported_formats']}")
    print(f"Supported sources: {info['supported_sources']}")
```

## üìä C·∫•u tr√∫c d·ªØ li·ªáu

### SearchResult
```python
@dataclass
class SearchResult:
    searched_images_count: int           # S·ªë ·∫£nh ƒë√£ t√¨m ki·∫øm
    searched_in_seconds: float           # Th·ªùi gian t√¨m ki·∫øm
    matches: List[Match]                 # Danh s√°ch k·∫øt qu·∫£ (best match lu√¥n ·ªü ƒë·∫ßu n·∫øu c√≥)
    your_image: Optional[YourImage]      # Th√¥ng tin ·∫£nh ƒë·∫ßu v√†o
    
    # Properties ti·ªán √≠ch
    is_found: bool                       # C√≥ t√¨m th·∫•y k·∫øt qu·∫£ ch√≠nh x√°c?
    best_matches: List[Match]            # K·∫øt qu·∫£ t·ªët nh·∫•t (c√≥ th·ªÉ nhi·ªÅu h∆°n 1)
    additional_matches: List[Match]      # K·∫øt qu·∫£ b·ªï sung
    possible_matches: List[Match]        # K·∫øt qu·∫£ c√≥ th·ªÉ
```

- `matches`: Best match (n·∫øu c√≥) lu√¥n l√† ph·∫ßn t·ª≠ ƒë·∫ßu ti√™n, c√°c match kh√°c theo sau.
- D√πng `result.best_matches` ƒë·ªÉ l·∫•y danh s√°ch best match, ho·∫∑c l·ªçc th·ªß c√¥ng t·ª´ `result.matches`.

### Match
```python
@dataclass
class Match:
    match_type: MatchType               # BEST, ADDITIONAL, POSSIBLE
    url: str                           # URL ·∫£nh g·ªëc
    preview_url: Optional[str]         # URL thumbnail
    similarity: Optional[float]        # ƒê·ªô t∆∞∆°ng t·ª± (%)
    resolution: Optional[Resolution]   # ƒê·ªô ph√¢n gi·∫£i
    source: Optional[Source]           # Ngu·ªìn (Danbooru, Gelbooru, v.v.)
    tags: Optional[List[str]]          # Tags (n·∫øu c√≥)
```

## üéØ V√≠ d·ª• n√¢ng cao

### Batch Processing
```python
import asyncio
from iqdb_api import IqdbClient

async def search_multiple_images(urls):
    async with IqdbClient() as client:
        tasks = [client.search_url(url) for url in urls]
        results = await asyncio.gather(*tasks, return_exceptions=True)
        
        for i, result in enumerate(results):
            if isinstance(result, Exception):
                print(f"URL {i+1} l·ªói: {result}")
            else:
                print(f"URL {i+1}: {len(result.matches)} k·∫øt qu·∫£")

urls = [
    "https://example.com/image1.jpg",
    "https://example.com/image2.jpg",
    "https://example.com/image3.jpg"
]
asyncio.run(search_multiple_images(urls))
```

### Custom Configuration
```python
from iqdb_api import IqdbClient

# Custom rate limiting v√† timeout
async with IqdbClient(
    rate_limit_seconds=3.0,    # 3 gi√¢y gi·ªØa m·ªói request
    timeout=60.0,              # 60 gi√¢y timeout
    user_agent="MyApp/1.0"     # Custom User-Agent
) as client:
    result = await client.search_url("https://example.com/image.jpg")
```

### Error Handling
```python
from iqdb_api import IqdbClient
from iqdb_api.exceptions import (
    ImageTooLargeException,
    HttpRequestFailedException,
    NotImageException
)

async with IqdbClient() as client:
    try:
        result = await client.search_file("large_image.jpg")
    except ImageTooLargeException:
        print("·∫¢nh qu√° l·ªõn (>8MB)")
    except HttpRequestFailedException:
        print("Kh√¥ng th·ªÉ download ·∫£nh t·ª´ URL")
    except NotImageException:
        print("File kh√¥ng ph·∫£i l√† ·∫£nh h·ª£p l·ªá")
```

## üåê Supported Sources

### 2D IQDB (www.iqdb.org)
- Danbooru
- Konachan  
- Yande.re
- Gelbooru
- Sankaku Channel
- e-shuushuu
- The Anime Gallery
- Zerochan
- Anime-Pictures

### 3D IQDB (3d.iqdb.org)
- 3Dbooru
- Idol Complex

## ‚öôÔ∏è Configuration

### Rate Limiting
IQDB y√™u c·∫ßu delay gi·ªØa c√°c request ƒë·ªÉ tr√°nh b·ªã ban. Default l√† 5.1 gi√¢y.

```python
# Thay ƒë·ªïi rate limit (c·∫©n th·∫≠n!)
client = IqdbClient(rate_limit_seconds=3.0)  # Ng·∫Øn h∆°n c√≥ th·ªÉ b·ªã ban
```

### File Size Limits
- Maximum file size: **8MB**
- Supported formats: JPG, PNG, GIF, WebP (v√† h·∫ßu h·∫øt image formats)

## üö® L∆∞u √Ω quan tr·ªçng

1. **Rate Limiting**: Lu√¥n t√¥n tr·ªçng rate limiting ƒë·ªÉ tr√°nh b·ªã ban IP
2. **Terms of Service**: Tu√¢n th·ªß [ToS c·ªßa IQDB](https://iqdb.org/)  
3. **Fair Use**: Kh√¥ng spam requests ho·∫∑c s·ª≠ d·ª•ng cho m·ª•c ƒë√≠ch th∆∞∆°ng m·∫°i m√† kh√¥ng ƒë∆∞·ª£c ph√©p
4. **Network**: IQDB c√≥ th·ªÉ ch·∫≠m ho·∫∑c kh√¥ng kh·∫£ d·ª•ng t·∫°m th·ªùi

## üîß Development

### Setup Development Environment
```bash
# Clone repository
git clone https://github.com/hieuxyz00/iqdb-api-python.git
cd iqdb-api-python

# T·∫°o virtual environment
python -m venv venv
source venv/bin/activate  # Linux/Mac
# venv\Scripts\activate     # Windows

# Install dependencies
pip install -e ".[dev]"
```

### Running Tests
```bash
pytest tests/ -v
```

### Code Quality
```bash
# Format code
black src/ tests/ examples/

# Check types
mypy src/

# Lint
flake8 src/ tests/
```

## üìù Changelog

### v1.0.0 (2025-06-19)
- ‚ú® Initial release
- üîç Support cho search URL v√† file upload
- üéØ H·ªó tr·ª£ c·∫£ 2D v√† 3D IQDB
- ‚ö° Async v√† sync APIs
- üõ°Ô∏è Rate limiting v√† error handling
- üì¶ Type hints ƒë·∫ßy ƒë·ªß
- üõ°Ô∏è **Ban Prevention** - User-Agent rotation, random delays
- üé® **Advanced Search Options** - ignore_colors, search_more parameters
- üìä **Information APIs**(build-in) - get_supported_formats(), get_supported_sources()
- üß™ **Comprehensive Testing** - Unit tests, integration tests
- üì¶ **Better Packaging** - Auto-publish to PyPI

## ü§ù Contributing

Contributions are welcome! Please feel free to submit a Pull Request.

1. Fork repository
2. T·∫°o feature branch (`git checkout -b feature/amazing-feature`)
3. Commit changes (`git commit -m 'Add amazing feature'`)
4. Push to branch (`git push origin feature/amazing-feature`)
5. Open Pull Request

## üìÑ License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

## üôè Acknowledgments

- [ImoutoChan/IqdbApi](https://github.com/ImoutoChan/IqdbApi) - Th∆∞ vi·ªán C# g·ªëc
- [IQDB.org](https://iqdb.org) - D·ªãch v·ª• t√¨m ki·∫øm h√¨nh ·∫£nh ng∆∞·ª£c tuy·ªát v·ªùi
- Community - T·∫•t c·∫£ nh·ªØng ng∆∞·ªùi ƒë√£ ƒë√≥ng g√≥p v√† feedback

## üìû Support

- üêõ **Bug Reports**: [GitHub Issues](https://github.com/hieuxyz00/iqdb-api-python/issues)
- üí° **Feature Requests**: [GitHub Issues](https://github.com/hieuxyz00/iqdb-api-python/issues)
- üìß **Email**: hieuxyzsmtp@gmail.com

## üöÄ Quick Start v·ªõi Discord

```bash
# Test link
python -c "
import asyncio
from iqdb_api import IqdbClient

async def test():
    async with IqdbClient(prevent_bans=True) as client:
        # Thay YOUR_TEST_URL b·∫±ng link th·ª±c
        result = await client.search_url('YOUR_TEST_URL')
        print(f'Found {len(result.matches)} matches!')

asyncio.run(test())
"
```

## üõ†Ô∏è Fallback t·ª± ƒë·ªông khi g·∫∑p l·ªói ƒë·ªãnh d·∫°ng ·∫£nh

N·∫øu g·∫∑p l·ªói ki·ªÉu `Not an image or image format not supported (server says it is application/octet-stream)` khi t√¨m ki·∫øm b·∫±ng URL, th∆∞ vi·ªán s·∫Ω t·ª± ƒë·ªông t·∫£i ·∫£nh v·ªÅ r·ªìi upload l·∫°i ƒë·ªÉ tƒÉng kh·∫£ nƒÉng nh·∫≠n di·ªán.

## ‚è≥ Timeout v√¥ h·∫°n

M·∫∑c ƒë·ªãnh m·ªçi request t·ªõi IQDB s·∫Ω kh√¥ng timeout (timeout=None). B·∫°n c√≥ th·ªÉ c·∫•u h√¨nh timeout khi kh·ªüi t·∫°o client n·∫øu mu·ªën.

## ‚ö†Ô∏è X·ª≠ l√Ω KeyboardInterrupt & CancelledError (User Cancel)

Khi ng∆∞·ªùi d√πng nh·∫•n Ctrl+C ho·∫∑c task b·ªã h·ªßy (asyncio.CancelledError), IQDB API Python s·∫Ω raise exception `UserCancelledException`.

B·∫°n n√™n catch exception n√†y ƒë·ªÉ x·ª≠ l√Ω UI/UX ƒë·∫πp, v√≠ d·ª•:

```python
from iqdb_api import IqdbClient, UserCancelledException
import asyncio

async def main():
    try:
        async with IqdbClient() as client:
            async for result in client.search_url_stream("https://example.com/image.jpg"):
                # ... x·ª≠ l√Ω k·∫øt qu·∫£ ...
    except UserCancelledException as e:
        print(f"ƒê√£ h·ªßy thao t√°c: {e}")
    except Exception as e:
        print(f"L·ªói kh√°c: {e}")

try:
    asyncio.run(main())
except KeyboardInterrupt:
    print("ƒê√£ h·ªßy thao t√°c b·ªüi ng∆∞·ªùi d√πng (KeyboardInterrupt)")
```

- Sync API c≈©ng s·∫Ω raise `UserCancelledException` n·∫øu b·ªã Ctrl+C.
- Exception n√†y lu√¥n c√≥ message r√µ r√†ng, kh√¥ng ƒë·ªÉ traceback x·∫•u ra ngo√†i.

### V√≠ d·ª• truy c·∫≠p k·∫øt qu·∫£:

```python
for match in result.matches:
    print(match.url)
    print(match.preview_url)
```
---

<div align="center">
Made with ‚ù§Ô∏è by <strong>hieuxyz00 (aka hieuxyz)</strong>
</div>